<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>展示頁 · data.json</title>
  <style>
    :root{
      --border:#e5e7eb;
      --muted:#6b7280;
      --red:#fee2e2;
      --green:#dcfce7;
      --yellow:#fef9c3;
      --card-bg:#ffffff;
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"PingFang TC","Microsoft JhengHei",sans-serif;
      color:#111; background:#fafafa;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:#ffffffcc; backdrop-filter:saturate(140%) blur(6px);
      border-bottom:1px solid var(--border);
    }
    .container{ max-width:900px; margin:0 auto; padding:12px 16px }
    h1{ margin:0 0 8px; font-size:20px }
    .meta{ color:var(--muted); font-size:12px }
    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px }
    button, .btn{
      padding:8px 10px; border:1px solid var(--border);
      border-radius:10px; background:#fff; color:#111; text-decoration:none; display:inline-block; cursor:pointer;
    }

    /* 頁面顯示：單列垂直清單（置中） */
    .list{ display:flex; flex-direction:column; gap:8px; margin-top:12px }
    
    /* 卡片：固定大小、橫向排列名字與時間 */
    .card{
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 5px;
      width: 190px;
      height: 40px;
      padding: 10px 12px;
      margin: 0 auto;
      display: flex;
      flex-direction: row;            /* 橫向排版 */
      align-items: center;            /* 垂直置中 */
      justify-content: space-between; /* 左右對齊 */
      text-align: left;               /* 名字靠左 */
      gap: 6px;
      box-sizing: border-box;
    }
    
    /* 名字：靠左，允許換行 */
    .card .name{
      font-weight: 600;
      font-size: 16px;
      line-height: 1.2;
      flex: 1;                        /* 名字占剩餘寬度 */
      word-break: break-word;
    }
    
    /* 時間：靠右，固定寬度，字型對齊 */
    .card .time{
      font-variant-numeric: tabular-nums;
      font-size: 14px;
      color: #374151;
      white-space: nowrap;
      margin-left: 8px;
      flex-shrink: 0;
    }
    
    .name{ font-weight:600; line-height:1.2; margin-bottom:6px; word-break:break-word }
    .time{ font-variant-numeric:tabular-nums; color:#374151 }
    .status-green{ background: var(--green); }
    .status-red{ background: var(--red); }
    .status-yellow{ background: var(--yellow); }

    .legend{ display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px; }
    .chip{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border) }
    .chip.red{ background:var(--red) }
    .chip.green{ background:var(--green) }
    .chip.yellow{ background:var(--yellow) }

    /* 匯出時加白底 */
    .exporting { background:#fff !important; }

    /* 表格匯出樣式（匯出時動態掛在暫存節點上） */
    .export-table-wrap{
      position: fixed; left: -200vw; top: 0; /* 螢幕外，避免閃爍 */
      background: #fff;
      padding: 12px;
      border: 1px solid var(--border);
    }
    .export-table{
      border-collapse: collapse;
      table-layout: fixed;          /* 固定欄寬 */
      background:#fff;
    }
    .export-table td{
      width: 190px;                 /* 單格寬（對齊卡片）*/
      height: 40px;                 /* 單格高（對齊卡片）*/
      border: 1px solid var(--border);
      vertical-align: middle;
      text-align: center;
      padding: 6px 4px;
      font-size: 14px;
    }
    .export-table .cell-name{
      display:block; font-weight:600; margin-bottom:4px; word-break:break-word;
    }
    .export-table .cell-time{
      display:block; font-variant-numeric:tabular-nums; color:#374151;
    }
    .export-green{ background: var(--green); }
    .export-red{ background: var(--red); }
    .export-yellow{ background: var(--yellow); }
  </style>

  <!-- html2canvas（DOM 轉成圖片） -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>展示頁</h1>
      <div class="toolbar">
        <button id="reload">重新讀取</button>
        <a class="btn" href="./name.html">編輯排序（name.html）</a>
        <a class="btn" href="./time.html">編輯時間（time.html）</a>
        <button id="download-cards">下載 PNG（卡片）</button>
        <button id="download-table">下載 PNG（表格）</button>

        <div class="legend" style="margin-left:8px">
          <span class="chip green">已重生</span>
          <span class="chip red">今天已過去</span>
          <span class="chip yellow">未來中最接近現在</span>
        </div>
        <span id="meta" class="meta" aria-live="polite" style="margin-left:auto"></span>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="list" class="list" aria-live="polite"></div>
  </main>

  <script>
  /* === GitHub 讀檔設定（方案2：Contents API 直讀） === */
  const GH_OWNER  = "Hades1225-design";
  const GH_REPO   = "HadesEidolon";
  const GH_BRANCH = "main";

  async function fetchDataJSON(){
    const url = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/public/data.json?ref=${GH_BRANCH}&ts=${Date.now()}`;
    const res = await fetch(url, {
      headers: { "Accept": "application/vnd.github.v3.raw" }, // 直接拿純文字
      cache: "no-store"
    });
    if(!res.ok) throw new Error(`HTTP ${res.status}（讀取 GitHub Contents 失敗）`);
    const text = await res.text();
    try { return JSON.parse(text); }
    catch(e){ console.error("data.json 內容：", text); throw new Error("JSON 解析失敗"); }
  }

  const GITHUB_API = "https://api.github.com/repos/Hades1225-design/HadesEidolon/commits?path=public/data.json&page=1&per_page=1";
  const WRAP_CUTOFF = "0559"; // 00:00–05:59 視為隔日清晨（不標紅）

  const $list = document.getElementById('list');
  const $meta = document.getElementById('meta');
  document.getElementById('reload').onclick = () => init(true);
  document.getElementById('download-cards').onclick = downloadPNG_Cards;
  document.getElementById('download-table').onclick = downloadPNG_Table;

  let items = []; // [ [name, hhmm|null], ... ]

  init(false);

  async function init(manual){
    try{
      const arr = await fetchDataJSON();
      items = normalize(arr);

      // 以距離現在分鐘差排序（循環24h）：過去在前、未來在後；null 最前
      items.sort((a,b)=>{
        const da = diffFromNow(a[1]);
        const db = diffFromNow(b[1]);
        if(a[1] === null && b[1] === null) return 0;
        if(a[1] === null) return -1;
        if(b[1] === null) return 1;
        return da - db;
      });

      render();
      await updateMetaTime();
    }catch(e){
      items = [];
      render();
      if(manual) alert("讀取失敗：" + e.message);
      $meta.textContent = `讀取失敗：${e.message}`;
      console.error(e);
    }
  }

  function normalize(arr){
    if(!Array.isArray(arr)) return [];
    return arr.map(item=>{
      if(Array.isArray(item)){
        const name = String(item[0] ?? '');
        const t = item[1];
        const time = (typeof t === 'string' && /^\d{4}$/.test(t)) ? t : null;
        return [name, time];
      }
      if(typeof item === 'string') return [item, null];
      if(item && typeof item === 'object'){
        const name = String(item.名字 ?? item.name ?? '');
        const t = item.時間 ?? item.time;
        const time = (typeof t === 'string' && /^\d{4}$/.test(t)) ? t : null;
        return [name, time];
      }
      return ['', null];
    });
  }

  // 排序用：回傳相對現在的差（分鐘）
  function diffFromNow(hhmm){
    if(hhmm === null) return -1e9; // null 最前
    const now = nowMinutes();
    const tm  = HHmmToMinutes(hhmm);
    const raw = tm - now;
    const isEarlyMorning = hhmm <= WRAP_CUTOFF;
    if(raw < 0 && isEarlyMorning){
      return raw + 1440; // 視為明天清晨→轉正
    }
    return raw;
  }

  function render(){
  $list.innerHTML = '';
  const nowHHmm = hhmmNow();
  const nextIdx = findNextClosestIndex(items, nowHHmm);

  items.forEach(([name, t], idx)=>{
    const card = document.createElement('div');
    card.className = 'card';

    // 名字
    const title = document.createElement('div');
    title.className = 'name';
    title.textContent = name || '—';

    // 時間
    const sub = document.createElement('div');
    sub.className = 'time';

    if(t === null){
      sub.textContent = '已重生';
      card.classList.add('status-green');
    }else{
      sub.textContent = toDisplay(t);
      const raw = HHmmToMinutes(t) - nowMinutes();
      const isEarlyMorning = t <= WRAP_CUTOFF;

      if(raw < 0 && !isEarlyMorning){
        card.classList.add('status-red');
      }else if(idx === nextIdx){
        card.classList.add('status-yellow');
      }
    }

    // 新結構：名字靠左，時間靠右
    card.append(title, sub);
    $list.appendChild(card);
  });
}

  function hhmmNow(){
    const d = new Date();
    return String(d.getHours()).padStart(2,'0') + String(d.getMinutes()).padStart(2,'0');
  }
  function nowMinutes(){
    const d = new Date();
    return d.getHours()*60 + d.getMinutes();
  }
  function HHmmToMinutes(hhmm){
    const h = +hhmm.slice(0,2), m = +hhmm.slice(2,4);
    return h*60 + m;
  }
  function toDisplay(hhmm){
    return hhmm.slice(0,2) + ':' + hhmm.slice(2,4);
  }
  function findNextClosestIndex(arr, nowHHmm){
    const now = HHmmToMinutes(nowHHmm);
    let bestIdx = -1, bestDelta = Infinity;
    arr.forEach(([_, t], idx)=>{
      if(typeof t === 'string' && /^\d{4}$/.test(t)){
        const tm = HHmmToMinutes(t);
        const delta = (tm - now + 1440) % 1440; // 0..1439
        if (delta > 0 && delta < bestDelta){
          bestDelta = delta;
          bestIdx = idx;
        }
      }
    });
    return bestIdx;
  }

  /* ========= 匯出 PNG（卡片：維持你原本的 Grid 30/列） ========= */
  async function downloadPNG_Cards(){
    if (!window.html2canvas){ alert("圖片匯出工具載入中，請再試一次。"); return; }
    const target = document.getElementById('list');
    const originalClass = target.className;

    // 臨時切成 30 欄 Grid
    target.classList.add('export-grid'); // 這個 class 不在 CSS；直接用內嵌 style 控制：
    target.style.display = "grid";
    target.style.gridTemplateColumns = "repeat(5, 190px)";
    target.style.gridAutoRows = "40px";
    target.style.gap = "8px";
    Array.from(target.children).forEach(el => { el.style.margin = "0"; });

    document.body.classList.add('exporting');
    if (document.fonts && document.fonts.ready) { try { await document.fonts.ready; } catch{} }

    const canvas = await html2canvas(target, {
      backgroundColor:'#ffffff', scale:2, useCORS:true,
      windowWidth: target.scrollWidth, windowHeight: target.scrollHeight
    });

    triggerDownload(canvas.toDataURL('image/png'), `cards_${stamp()}.png`);

    // 還原
    target.className = originalClass;
    target.removeAttribute('style');
    Array.from(target.children).forEach(el => { el.style.removeProperty('margin'); });
    document.body.classList.remove('exporting');
  }

  /* ========= 匯出 PNG（表格：每行 30 欄，左到右、上到下） ========= */
  async function downloadPNG_Table(){
    if (!window.html2canvas){ alert("圖片匯出工具載入中，請再試一次。"); return; }

    // 先準備顏色判定（跟畫面相同邏輯）
    const nowHHmm = hhmmNow();
    const nextIdx = findNextClosestIndex(items, nowHHmm);

    // 動態建立隱藏表格（放到畫面外）
    const wrap = document.createElement('div');
    wrap.className = 'export-table-wrap';
    const table = document.createElement('table');
    table.className = 'export-table';

    const perRow = 5;
    const rowsCount = Math.ceil(items.length / perRow);

    for(let r=0; r<rowsCount; r++){
      const tr = document.createElement('tr');
      for(let c=0; c<perRow; c++){
        const idx = r*perRow + c;
        const td  = document.createElement('td');

        if(idx < items.length){
          const [name, t] = items[idx] || ["", null];

          // 內容
          const nSpan = document.createElement('span');
          nSpan.className = 'cell-name';
          nSpan.textContent = name || '—';

          const tSpan = document.createElement('span');
          tSpan.className = 'cell-time';
          if(t === null){
            tSpan.textContent = '已重生';
            td.classList.add('export-green');
          }else{
            tSpan.textContent = toDisplay(t);
            const raw = HHmmToMinutes(t) - nowMinutes();
            const isEarlyMorning = t <= WRAP_CUTOFF;

            if(raw < 0 && !isEarlyMorning){
              td.classList.add('export-red');      // 今天已過去
            }else if(idx === nextIdx){
              td.classList.add('export-yellow');   // 未來中最近
            }
          }

          td.append(nSpan, tSpan);
        }else{
          td.innerHTML = '&nbsp;'; // 補空格以維持框線
        }
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }

    wrap.appendChild(table);
    document.body.appendChild(wrap);

    document.body.classList.add('exporting');
    if (document.fonts && document.fonts.ready) { try { await document.fonts.ready; } catch{} }

    const canvas = await html2canvas(wrap, {
      backgroundColor:'#ffffff', scale:2, useCORS:true,
      windowWidth: wrap.scrollWidth, windowHeight: wrap.scrollHeight
    });

    triggerDownload(canvas.toDataURL('image/png'), `table_${stamp()}.png`);

    // 清理
    document.body.removeChild(wrap);
    document.body.classList.remove('exporting');
  }

  /* ========= 工具 ========= */
  function triggerDownload(url, filename){
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
  }
  function stamp(){
    const d = new Date(), z = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}_${z(d.getHours())}${z(d.getMinutes())}${z(d.getSeconds())}`;
  }

  // 顯示 GitHub 上 data.json 的最後修改時間
  async function updateMetaTime(){
    try{
      const r = await fetch(GITHUB_API, { cache:"no-store" });
      if(!r.ok) throw new Error(`HTTP ${r.status}（讀取 GitHub commit 失敗）`);
      const commits = await r.json();
      if(Array.isArray(commits) && commits.length){
        const iso = commits[0].commit.committer.date;
        $meta.textContent = `最後更新：${new Date(iso).toLocaleString()}`;
      }else{
        $meta.textContent = `最後更新時間未知`;
      }
    }catch(e){
      $meta.textContent = `最後更新時間讀取失敗`;
      console.error(e);
    }
  }
  </script>
</body>
</html>
