<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>天堂 - BOSS時間</title>
  <style>
    :root{
      --border:#e5e7eb;
      --muted:#6b7280;
      --red:#fee2e2;
      --green:#dcfce7;
      --yellow:#fef9c3;
      --card-bg:#ffffff;
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"PingFang TC","Microsoft JhengHei",sans-serif;
      color:#111; background:#fafafa;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:#ffffffcc; backdrop-filter:saturate(140%) blur(6px);
      border-bottom:1px solid var(--border);
    }
    .container{ max-width:900px; margin:0 auto; padding:12px 16px }
    h1{ margin:0 0 8px; font-size:20px }
    .meta{ color:var(--muted); font-size:12px }
    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px }
    button, .btn{
      padding:8px 10px; border:1px solid var(--border);
      border-radius:10px; background:#fff; color:#111; text-decoration:none; display:inline-block; cursor:pointer;
    }

    /* 預設：單列垂直清單（置中） */
    .list{
      display:flex; flex-direction:column; gap:8px; margin-top:12px;
    }

    /* 匯出模式：每列 30 張卡片 
    .export-grid{
      display:grid !important;
      grid-template-columns: repeat(30, minmax(0, 1fr));
      gap:8px;
      justify-content:center;
      align-items:start;
    }
    */
        /* 取代原本的 .export-grid 定義 */
    /* 匯出版：多列 Grid，一列最多 30 張 */
    .export-grid{
      display:grid !important;
      grid-template-columns: repeat(20, 216px); /* 每列 30 張 min-content */
      grid-auto-rows: repeat(10, 96px);
      gap:8px;
      justify-content:flex-start;
      align-content:start;
      width:max-content;
    }
    
    /* 匯出版卡片固定大小，取消 margin:auto */
    .export-grid .card{
      margin:0;
      width:216px;
      height:96px;
    }  
     
    /* 固定卡片大小：寬 216px，高 96px；置中 */
    .card{
      background:var(--card-bg); border:1px solid var(--border); border-radius:10px;
      width:216px; height:96px; padding:10px;
      margin:0 auto;
      display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;
    }
    .name{ font-weight:600; line-height:1.2; margin-bottom:6px; word-break:break-word }
    .time{ font-variant-numeric:tabular-nums; color:#374151 }

    .status-green{ background: var(--green); }
    .status-red{ background: var(--red); }
    .status-yellow{ background: var(--yellow); }

    .legend{ display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px; }
    .chip{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border) }
    .chip.red{ background:var(--red) }
    .chip.green{ background:var(--green) }
    .chip.yellow{ background:var(--yellow) }

    /* 匯出時加白底 */
    .exporting { background:#fff !important; }
  </style>
  <!-- html2canvas（DOM 轉成圖片） -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>BOSS時間</h1>
      <div class="toolbar">
        <button id="reload">重新讀取</button>
        <a class="btn" href="./name.html">編輯排序</a>
        <a class="btn" href="./time.html">編輯時間</a>
        <button id="download">下載 PNG</button>

        <div class="legend" style="margin-left:8px">
          <span class="chip green">已重生</span>
          <span class="chip red">超時</span>
          <span class="chip yellow">即將重生</span>
        </div>
        <span id="meta" class="meta" aria-live="polite" style="margin-left:auto"></span>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="list" class="list" aria-live="polite"></div>
  </main>

  <script>
  const DATA_URL = "https://raw.githubusercontent.com/Hades1225-design/HadesEidolon/main/public/data.json";
  const GITHUB_API = "https://api.github.com/repos/Hades1225-design/HadesEidolon/commits?path=public/data.json&page=1&per_page=1";
  const WRAP_CUTOFF = "0559"; // 00:00–05:59 視為隔日清晨（不標紅）

  const $list = document.getElementById('list');
  const $meta = document.getElementById('meta');
  document.getElementById('reload').onclick = () => init(true);
  document.getElementById('download').onclick = downloadPNG;

  let items = []; // [ [name, hhmm|null], ... ]

  init(false);

  async function init(manual){
    try{
      const r = await fetch(DATA_URL + "?t=" + Date.now(), { cache:"no-store" });
      if(!r.ok) throw new Error(`HTTP ${r.status}（讀取 ${DATA_URL} 失敗）`);
      const arr = JSON.parse(await r.text());
      items = normalize(arr);

      // 以距離現在分鐘差排序（循環24h）
      items.sort((a,b)=>{
        const da = diffFromNow(a[1]);
        const db = diffFromNow(b[1]);
        if(a[1] === null && b[1] === null) return 0;
        if(a[1] === null) return -1;
        if(b[1] === null) return 1;
        return da - db;
      });

      render();
      await updateMetaTime();
    }catch(e){
      items = [];
      render();
      if(manual) alert("讀取失敗：" + e.message);
      $meta.textContent = `讀取失敗：${e.message}`;
      console.error(e);
    }
  }

  function normalize(arr){
    if(!Array.isArray(arr)) return [];
    return arr.map(item=>{
      if(Array.isArray(item)){
        const name = String(item[0] ?? '');
        const t = item[1];
        const time = (typeof t === 'string' && /^\d{4}$/.test(t)) ? t : null;
        return [name, time];
      }
      if(typeof item === 'string') return [item, null];
      if(item && typeof item === 'object'){
        const name = String(item.名字 ?? item.name ?? '');
        const t = item.時間 ?? item.time;
        const time = (typeof t === 'string' && /^\d{4}$/.test(t)) ? t : null;
        return [name, time];
      }
      return ['', null];
    });
  }

  function diffFromNow(hhmm){
    if(hhmm === null) return -1e9; // null 最前
    const now = nowMinutes();
    const tm  = HHmmToMinutes(hhmm);
    const raw = tm - now;
    const isEarlyMorning = hhmm <= WRAP_CUTOFF;
    if(raw < 0 && isEarlyMorning){
      return raw + 1440;
    }
    return raw;
  }

  function render(){
    $list.innerHTML = '';
    const nowHHmm = hhmmNow();
    const nextIdx = findNextClosestIndex(items, nowHHmm);

    items.forEach(([name, t], idx)=>{
      const card = document.createElement('div');
      card.className = 'card';

      const title = document.createElement('div');
      title.className = 'name';
      title.textContent = name || '—';

      const sub = document.createElement('div');
      sub.className = 'time';

      if(t === null){
        sub.textContent = '已重生';
        card.classList.add('status-green');
      }else{
        sub.textContent = toDisplay(t);

        const raw = HHmmToMinutes(t) - nowMinutes();
        const isEarlyMorning = t <= WRAP_CUTOFF;

        if(raw < 0 && !isEarlyMorning){
          card.classList.add('status-red');
        }else if(idx === nextIdx){
          card.classList.add('status-yellow');
        }
      }

      card.append(title, sub);
      $list.appendChild(card);
    });
  }

  function hhmmNow(){
    const d = new Date();
    return String(d.getHours()).padStart(2,'0') + String(d.getMinutes()).padStart(2,'0');
  }
  function nowMinutes(){
    const d = new Date();
    return d.getHours()*60 + d.getMinutes();
  }
  function HHmmToMinutes(hhmm){
    const h = +hhmm.slice(0,2), m = +hhmm.slice(2,4);
    return h*60 + m;
  }
  function toDisplay(hhmm){
    return hhmm.slice(0,2) + ':' + hhmm.slice(2,4);
  }
  function findNextClosestIndex(arr, nowHHmm){
    const now = HHmmToMinutes(nowHHmm);
    let bestIdx = -1, bestDelta = Infinity;
    arr.forEach(([_, t], idx)=>{
      if(typeof t === 'string' && /^\d{4}$/.test(t)){
        const tm = HHmmToMinutes(t);
        const delta = (tm - now + 1440) % 1440;
        if (delta > 0 && delta < bestDelta){
          bestDelta = delta;
          bestIdx = idx;
        }
      }
    });
    return bestIdx;
  }

  
  
  async function downloadPNG(){
    if (!window.html2canvas){
      alert("圖片匯出工具載入中，請再試一次。");
      return;
    }
  
    const target = document.getElementById('list');
    const originalClass = target.className;
  
    // 切換為 Grid 匯出模式
    target.classList.add('export-grid');
    document.body.classList.add('exporting');
  
    // 等待字型載入完成，避免位置錯亂
    if (document.fonts && document.fonts.ready) {
      try { await document.fonts.ready; } catch {}
    }
  
    // 匯出
    const canvas = await html2canvas(target, {
      backgroundColor: '#ffffff',
      scale: 2,
      useCORS: true,
      windowWidth: target.scrollWidth,
      windowHeight: target.scrollHeight
    });
  
    const url = canvas.toDataURL('image/png');
    triggerDownload(url, `cards_${stamp()}.png`);
  
    // 還原原本單列模式
    target.className = originalClass;
    document.body.classList.remove('exporting');
  }


  function triggerDownload(url, filename){
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }
  function stamp(){
    const d = new Date();
    const z = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}_${z(d.getHours())}${z(d.getMinutes())}${z(d.getSeconds())}`;
  }

  async function updateMetaTime(){
    try{
      const r = await fetch(GITHUB_API, { cache:"no-store" });
      if(!r.ok) throw new Error(`HTTP ${r.status}（讀取 GitHub commit 失敗）`);
      const commits = await r.json();
      if(Array.isArray(commits) && commits.length){
        const iso = commits[0].commit.committer.date;
        $meta.textContent = `最後更新：${new Date(iso).toLocaleString()}`;
      }else{
        $meta.textContent = `最後更新時間未知`;
      }
    }catch(e){
      $meta.textContent = `最後更新時間讀取失敗`;
      console.error(e);
    }
  }
  </script>
</body>
</html>
